<?php
/**
 * KnowledgeBase.
 *
 * @copyright Axel Guckelsberger (Guite)
 * @license http://www.gnu.org/licenses/lgpl.html GNU Lesser General Public License
 * @author Axel Guckelsberger <info@guite.de>.
 * @link https://guite.de
 * @link http://zikula.org
 * @version Generated by ModuleStudio 0.6.1 (http://modulestudio.de).
 */

namespace Guite\KnowledgeBaseModule;

use Guite\KnowledgeBaseModule\Base\KnowledgeBaseModuleInstaller as BaseKnowledgeBaseModuleInstaller;

use Zikula\Module\CategoriesModule\Entity\CategoryEntity;
use Zikula\Module\CategoriesModule\Entity\CategoryRegistryEntity;
use LogUtil;
use CategoryUtil;

/**
 * Installer implementation class.
 */
class KnowledgeBaseModuleInstaller extends BaseKnowledgeBaseModuleInstaller
{
    /**
     * Install the KnowledgeBase application.
     *
     * @return boolean True on success, or false.
     */
    public function install()
    {
        $result = parent::install();

        // create the default categories for KnowledgeBase
        if (!$this->createDefaultCategories()) {
            return LogUtil::registerError($this->__('creation of default categories failed'));
        }

        return true;
    }

    /**
     * create the default categories for KnowledgeBase
     *
     * @author       Axel Guckelsberger
     * @return       bool       true if successful or false if something went wrong
     */
    private function createDefaultCategories()
    {
        // determine last category
        $dql = 'SELECT c
                FROM Zikula\Module\CategoriesModule\Entity\CategoryEntity c
                ORDER BY c.id DESC';
        $query = $this->entityManager->createQuery($dql);
        $query->setFirstResult(0)
              ->setMaxResults(1);
        $categories = $query->getResult();
        if (!count($categories)) {
            return false;
        }

        $lastCat = $categories[0];
        if ($lastCat === false || !$lastCat) {
            return false;
        }

        $nextCatID = $lastCat['id'] + 1;

        $rootCat = $this->entityManager->find('ZikulaCategoriesModule:CategoryEntity', 1); // 1 == __SYSTEM__
        $parentList = array($rootCat);
        $parentLvlOne = array();
        $parentLvlTwo = array();


        $catNames = array('en' => 'Knowledge Base',
                          'de' => 'Knowledge Base');
        $catDescriptions = array('en' => 'Main category for the Knowledge Base',
                                 'de' => 'Hauptkategorie für die Knowledge Base');
        $rootCat = $this->createSingleCategory($nextCatID++, $parentList, $catNames, $catDescriptions, 0);

        $parentList = array($rootCat);                  // reset to level one
        $catNames = array('en' => 'Ticket Categories',
                          'de' => 'Ticket-Kategorien');
        $catDescriptions = array('en' => 'Available topics for tickets',
                                 'de' => 'Verfügbare Themen für Tickets');
        $parentLvlOne = $this->createSingleCategory($nextCatID++, $parentList, $catNames, $catDescriptions, 0);

        $parentList = array($rootCat, $parentLvlOne);   // reset to level two
        {
            $catNames = array('en' => 'Installation',
                              'de' => 'Installation');
            $catDescriptions = array('en' => 'Installation of Zikula',
                                     'de' => 'Installation von Zikula');
            $parentLvlTwo = $this->createSingleCategory($nextCatID++, $parentList, $catNames, $catDescriptions);

            $catNames = array('en' => 'Configuration',
                              'de' => 'Konfiguration');
            $catDescriptions = array('en' => 'Configure Zikula and basic settings',
                                     'de' => 'Zikula konfigurieren und Grundeinstellungen');
            $parentLvlTwo = $this->createSingleCategory($nextCatID++, $parentList, $catNames, $catDescriptions);

            $catNames = array('en' => 'Modules',
                              'de' => 'Module');
            $catDescriptions = array('en' => 'Setup, manage and use modules',
                                     'de' => 'Module einrichten, verwalten und verwenden');
            $parentLvlTwo = $this->createSingleCategory($nextCatID++, $parentList, $catNames, $catDescriptions);

            $catNames = array('en' => 'Themes',
                              'de' => 'Themes');
            $catDescriptions = array('en' => 'Design your layout in Zikula',
                                     'de' => 'Realisiere Dein Design mit Zikula');
            $parentLvlTwo = $this->createSingleCategory($nextCatID++, $parentList, $catNames, $catDescriptions);

            $catNames = array('en' => 'Customisation',
                              'de' => 'Anpassung');
            $catDescriptions = array('en' => 'Your individual Zikula',
                                     'de' => 'Individualisierung von Zikula');
            $parentLvlTwo = $this->createSingleCategory($nextCatID++, $parentList, $catNames, $catDescriptions);

            $catNames = array('en' => 'Development',
                              'de' => 'Entwicklung');
            $catDescriptions = array('en' => 'Development of and for Zikula',
                                     'de' => 'Entwicklung von und für Zikula');
            $parentLvlTwo = $this->createSingleCategory($nextCatID++, $parentList, $catNames, $catDescriptions);

            $catNames = array('en' => 'Tools and Services',
                              'de' => 'Nützliche Werkzeuge');
            $catDescriptions = array('en' => 'AppStore and further tools',
                                     'de' => 'AppStore und andere Tools');
            $parentLvlTwo = $this->createSingleCategory($nextCatID++, $parentList, $catNames, $catDescriptions);
        }


        // rebuild all path entries so that we can use them below
        CategoryUtil::rebuildPaths('path', 'name');
        CategoryUtil::rebuildPaths('ipath', 'id');

        // define category registration mappings to ticket table
        $mappingRootCats = array(
            array('prop' => 'TicketCategoryMain', 'rootPath' => '/__SYSTEM__/KnowledgeBase/TicketCategories')
        );

        foreach ($mappingRootCats as $mappingRoot) {
            $rootCat = CategoryUtil::getCategoryByPath($mappingRoot['rootPath']);

            $registry = new CategoryRegistryEntity();
            $registry->setModname('GuiteKnowledgeBaseModule');
            $registry->setEntityname('kbase_ticket');
            $registry->setProperty($mappingRoot['prop']);
            $registry->setCategory_Id($rootCat['id']);
            $this->entityManager->persist($registry);

            $this->setVar('baseCat' . $mappingRoot['prop'], $mappingRoot['rootPath']);
        }

        // now send everything to the database
        $this->entityManager->flush();

        return true;
    }

    private function createSingleCategory($catID, $parentArray, $catNames, $catDescriptions, $isLeaf = 1)
    {
        $path = '/__SYSTEM__';
        $ipath = '/1';
        $numParents = count($parentArray);
        if ($numParents > 0) {
            $path = $parentArray[$numParents -1]->getPath();
            $ipath = $parentArray[$numParents -1]->getIPath();
        }

        $path .= '/' . str_replace(' ', '', ucwords($catNames['en']));
        $ipath .= '/' . $catID;

        $category = new CategoryEntity();
        $category->setId($catID);
        if ($numParents > 0) {
            $category->setParent($parentArray[$numParents-1]);
        }
        $category->setName($catNames['en']);
        $category->setDisplay_name($catNames);
        $category->setDisplay_desc($catDescriptions);
        $category->setIs_leaf($isLeaf);
        $category->setPath($path);
        $category->setIPath($ipath);

        $this->entityManager->persist($category);

        // must flush here so later CategoryUtil functions can find the entity in the DB
        $this->entityManager->flush();

        return $category;
    }
}
